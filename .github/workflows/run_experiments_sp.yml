name: Run SP Experiments (v2.0.0)

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨
    inputs:
      experiment_set:
        description: 'Experiment set to run'
        required: true
        default: 'i2'
        type: choice
        options:
          - i2       # I-2: Instrument validation (4 experiments)
          - o2       # O-2: Topological dominance (4 experiments)
          - o3       # O-3: SP-SSC independence (3 experiments)
          - o4_synth # O-4: Value gate (synthetic only, 1 experiment, FAST)
          - o4       # O-4: Value gate (synthetic + BERT, 2 experiments, SLOW)
          - robust   # Robustness (3 experiments)
          - all_fast # All experiments EXCEPT BERT (faster)
          - all      # All experiments INCLUDING BERT (WARNING: very long runtime)
      
      n_trials:
        description: 'Number of trials per experiment'
        required: false
        default: '100'
        type: choice
        options:
          - '10'
          - '100'
          - '1000'

jobs:
  run-experiments:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3æ™‚é–“åˆ¶é™ï¼ˆBERTå¯¾å¿œï¼‰
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set environment for determinism
      run: |
        echo "OPENBLAS_NUM_THREADS=1" >> $GITHUB_ENV
        echo "MKL_NUM_THREADS=1" >> $GITHUB_ENV
        echo "NUMEXPR_NUM_THREADS=1" >> $GITHUB_ENV
        echo "OMP_NUM_THREADS=1" >> $GITHUB_ENV
    
    - name: Run I-2 experiments
      if: |
        inputs.experiment_set == 'i2' || 
        inputs.experiment_set == 'all_fast' || 
        inputs.experiment_set == 'all'
      run: |
        python -c "
        from src.experiments_sp.i2_sp_instrument.sp00_identity_isometry import run_sp00_identity_isometry
        from src.experiments_sp.i2_sp_instrument.sp01_full_destruction import run_sp01_full_destruction
        from src.experiments_sp.i2_sp_instrument.sp02_topology_rewire_curve import run_sp02_topology_rewire_curve
        from src.experiments_sp.i2_sp_instrument.sp03_layout_robustness import run_sp03_layout_robustness
        n_trials = ${{ inputs.n_trials }}
        print(f'Running I-2 experiments with n_trials={n_trials}')
        run_sp00_identity_isometry(n_trials=n_trials)
        run_sp01_full_destruction(n_trials=n_trials)
        run_sp02_topology_rewire_curve(n_trials=n_trials)
        run_sp03_layout_robustness(n_trials=n_trials)
        "
    
    - name: Run O-2 experiments
      if: |
        inputs.experiment_set == 'o2' || 
        inputs.experiment_set == 'all_fast' || 
        inputs.experiment_set == 'all'
      run: |
        python -c "
        from src.experiments_sp.o2_topological_dominance_sp.sp10_metric_invariance import run_sp10_metric_invariance
        from src.experiments_sp.o2_topological_dominance_sp.sp11_topology_sensitivity import run_sp11_topology_sensitivity
        from src.experiments_sp.o2_topological_dominance_sp.sp12_topology_vs_metric import run_sp12_topology_vs_metric
        from src.experiments_sp.o2_topological_dominance_sp.sp13_layout_generalization import run_sp13_layout_generalization
        n_trials = ${{ inputs.n_trials }}
        print(f'Running O-2 experiments with n_trials={n_trials}')
        run_sp10_metric_invariance(n_trials=n_trials)
        run_sp11_topology_sensitivity(n_trials=n_trials)
        run_sp12_topology_vs_metric(n_trials=n_trials)
        run_sp13_layout_generalization(n_trials=n_trials)
        "
    
    - name: Run O-3 experiments
      if: |
        inputs.experiment_set == 'o3' || 
        inputs.experiment_set == 'all_fast' || 
        inputs.experiment_set == 'all'
      run: |
        python -c "
        from src.experiments_sp.o3_stress_independence_sp_ssc.sp20_coord_noise_sp_ssc import run_sp20_coord_noise_sp_ssc
        from src.experiments_sp.o3_stress_independence_sp_ssc.sp21_semantic_noise_sp_ssc import run_sp21_semantic_noise_sp_ssc
        from src.experiments_sp.o3_stress_independence_sp_ssc.sp22_mixed_noise_grid import run_sp22_mixed_noise_grid
        n_trials = ${{ inputs.n_trials }}
        print(f'Running O-3 experiments with n_trials={n_trials}')
        run_sp20_coord_noise_sp_ssc(n_trials=n_trials)
        run_sp21_semantic_noise_sp_ssc(n_trials=n_trials)
        run_sp22_mixed_noise_grid(n_trials=n_trials)
        "
    
    - name: Run O-4 experiments (synthetic only)
      if: |
        inputs.experiment_set == 'o4_synth' || 
        inputs.experiment_set == 'o4' || 
        inputs.experiment_set == 'all_fast' || 
        inputs.experiment_set == 'all'
      run: |
        python -c "
        from src.experiments_sp.o4_value_gate_tradeoff_sp.sp30_lambda_sweep_synth import run_sp30_lambda_sweep_synth
        n_trials = ${{ inputs.n_trials }}
        print(f'Running O-4 (synthetic) with n_trials={n_trials}')
        run_sp30_lambda_sweep_synth(n_trials=n_trials)
        "
    
    - name: Run O-4 experiments (BERT) âš ï¸ SLOW
      if: inputs.experiment_set == 'o4' || inputs.experiment_set == 'all'
      run: |
        python -c "
        from src.experiments_sp.o4_value_gate_tradeoff_sp.sp31_lambda_sweep_bert import run_sp31_lambda_sweep_bert
        n_trials = ${{ inputs.n_trials }}
        print(f'âš ï¸  Running O-4 (BERT) with n_trials={n_trials}')
        print(f'âš ï¸  This may take 10-30 minutes or longer...')
        run_sp31_lambda_sweep_bert(n_trials=n_trials)
        "
    
    - name: Run Robustness experiments
      if: |
        inputs.experiment_set == 'robust' || 
        inputs.experiment_set == 'all_fast' || 
        inputs.experiment_set == 'all'
      run: |
        python -c "
        from src.experiments_sp.sp_robustness.sp40_dimN_sp_robustness import run_sp40_dimN_sp_robustness
        from src.experiments_sp.sp_robustness.sp41_layout_topology_sp_robustness import run_sp41_layout_topology_sp_robustness
        from src.experiments_sp.sp_robustness.sp42_knn_k_robustness import run_sp42_knn_k_robustness
        n_trials = ${{ inputs.n_trials }}
        print(f'Running Robustness experiments with n_trials={n_trials}')
        run_sp40_dimN_sp_robustness(n_trials=n_trials)
        run_sp41_layout_topology_sp_robustness(n_trials=n_trials)
        run_sp42_knn_k_robustness(n_trials=n_trials)
        "
    
    - name: Generate Summary All
      if: always()
      run: |
        python -m src.experiments_sp.generate_summary_all
    
    - name: Upload experiment outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: experiment-outputs-${{ inputs.experiment_set }}-n${{ inputs.n_trials }}
        path: outputs_sp/
        retention-days: 30
    
    - name: Generate experiment summary
      if: always()
      run: |
        echo "## Experiment Results (${{ inputs.experiment_set }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Parameters" >> $GITHUB_STEP_SUMMARY
        echo "- Experiment set: ${{ inputs.experiment_set }}" >> $GITHUB_STEP_SUMMARY
        echo "- n_trials: ${{ inputs.n_trials }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Output Files" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ Total files: $(find outputs_sp/ -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Summary files: $(find outputs_sp/ -name 'summary*.csv' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if ls outputs_sp/summary_all_*.csv 1> /dev/null 2>&1; then
          echo "### Generated Summary Files" >> $GITHUB_STEP_SUMMARY
          for f in outputs_sp/summary_all_*.csv; do
            echo "- $(basename $f): $(wc -l < $f) rows" >> $GITHUB_STEP_SUMMARY
          done
        fi
