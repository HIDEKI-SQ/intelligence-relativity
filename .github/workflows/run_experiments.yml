name: Run All Experiments

on:
  workflow_dispatch:
    inputs:
      experiments:
        description: 'Which experiments to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - quick_test
          - baseline_only

jobs:
  run-experiments:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run experiments
      run: |
        if [ "${{ inputs.experiments }}" = "quick_test" ]; then
          echo "Running quick test (N=10)..."
          python -c "import sys; sys.path.insert(0, 'src'); from src.experiments import exp_00_baseline; exp_00_baseline.N_TRIALS = 10; exp_00_baseline.run_exp00()"
        elif [ "${{ inputs.experiments }}" = "baseline_only" ]; then
          echo "Running EXP-00 baseline (N=1000)..."
          python -m src.experiments.exp_00_baseline
        else
          echo "Running all 15 experiments (N=1000)..."
          python -m src.experiments.exp_00_baseline
          python -m src.experiments.exp_01_spatial_vs_random
          python -m src.experiments.exp_02_grid_arrangement
          python -m src.experiments.exp_03_line_arrangement
          python -m src.experiments.exp_04_3d_cube_arrangement
          python -m src.experiments.exp_05_independence_permutation
          python -m src.experiments.exp_06_dimension_robustness
          python -m src.experiments.exp_07_sample_size_robustness
          python -m src.experiments.exp_08_metric_robustness
          python -m src.experiments.exp_09_topological_disruption
          python -m src.experiments.exp_10_rotation_invariance
          python -m src.experiments.exp_11_coordinate_noise
          python -m src.experiments.exp_12_semantic_noise
          python -m src.experiments.exp_13_value_gate_sweep
        fi
    
    - name: Upload results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: experiment-results-${{ github.run_number }}
        path: outputs/
        retention-days: 90
    
    - name: Generate summary
      if: always()
      run: |
        echo "## Experiment Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Completed Experiments" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        for dir in outputs/*/; do
          if [ -d "$dir" ]; then
            exp_name=$(basename "$dir")
            echo "âœ… $exp_name" >> $GITHUB_STEP_SUMMARY
          fi
        done
