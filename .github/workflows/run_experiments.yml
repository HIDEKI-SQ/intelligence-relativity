name: Intelligence Relativity - Complete Experiment Suite

on:
  workflow_dispatch:
    inputs:
      include_beta:
        description: 'Include beta experiment (historical reference)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  run-complete-suite:
    name: Execute All Experiments
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install transformers torch
    
    - name: Execute experiment suite
      continue-on-error: true
      run: |
        set +e  # „Ç®„É©„Éº„Åß„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÅúÊ≠¢„Åó„Å™„ÅÑ
        
        echo "================================================================"
        echo "Intelligence Relativity - Complete Experiment Suite"
        echo "Empirical Validation of the Relativity Theory of Intelligence"
        echo "================================================================"
        echo ""
        echo "Total experiments: 17"
        echo "  - Core (EXP-00 to EXP-13): 14 experiments"
        echo "  - Supplementary (SUP-14, SUP-15): 2 experiments"
        echo "  - Beta (EXP-BETA): 1 experiment (historical)"
        echo ""
        echo "Include beta: ${{ inputs.include_beta }}"
        echo "================================================================"
        echo ""
        
        # Initialize counters
        SUCCESS_COUNT=0
        FAIL_COUNT=0
        TOTAL_COUNT=0
        
        # Experiment execution function
        run_experiment() {
          local sequence=$1
          local module=$2
          local description=$3
          
          # Increment counter (safe way)
          TOTAL_COUNT=$((TOTAL_COUNT + 1))
          
          echo ""
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "[$sequence/17] $description"
          echo "Module: $module"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          
          # Execute experiment
          if python -m src.experiments.$module 2>&1; then
            echo "‚úÖ SUCCESS: $module completed"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            echo "‚ö†Ô∏è  ISSUE: $module failed (continuing...)"
            FAIL_COUNT=$((FAIL_COUNT + 1))
          fi
        }
        
        # ============================================================
        # Core Experiments
        # ============================================================
        
        echo ""
        echo "================================================================"
        echo "CORE EXPERIMENTS (EXP-00 to EXP-13)"
        echo "================================================================"
        
        run_experiment 1 "exp_00_baseline" "EXP-00: Baseline (Natural Orthogonality)"
        run_experiment 2 "exp_01_spatial_vs_random" "EXP-01: Spatial Arrangements vs Random"
        run_experiment 3 "exp_02_grid_arrangement" "EXP-02: Grid Arrangement Validation"
        run_experiment 4 "exp_03_line_arrangement" "EXP-03: Line Arrangement Validation"
        run_experiment 5 "exp_04_3d_cube_arrangement" "EXP-04: 3D Cube Arrangement"
        run_experiment 6 "exp_05_independence_permutation" "EXP-05: Independence via Permutation"
        run_experiment 7 "exp_06_dimension_robustness" "EXP-06: Embedding Dimension Robustness"
        run_experiment 8 "exp_07_sample_size_robustness" "EXP-07: Sample Size Robustness"
        run_experiment 9 "exp_08_metric_robustness" "EXP-08: Distance Metric Robustness"
        run_experiment 10 "exp_09_topological_disruption" "EXP-09: Topological Disruption (O-2)"
        run_experiment 11 "exp_10_rotation_invariance" "EXP-10: Rotation Invariance"
        run_experiment 12 "exp_11_coordinate_noise" "EXP-11: Coordinate Noise (O-3)"
        run_experiment 13 "exp_12_semantic_noise" "EXP-12: Semantic Noise (O-3)"
        run_experiment 14 "exp_13_value_gate_sweep" "EXP-13: Value Gate Œª-Sweep (O-4)"
        
        # ============================================================
        # Supplementary Experiments
        # ============================================================
        
        echo ""
        echo "================================================================"
        echo "SUPPLEMENTARY EXPERIMENTS (SUP-14, SUP-15)"
        echo "================================================================"
        
        run_experiment 15 "sup_exp_14_bert" "SUP-14: BERT Real-World Validation"
        run_experiment 16 "sup_exp_15_multilingual" "SUP-15: Cross-Linguistic Validation"
        
        # ============================================================
        # Beta Experiment
        # ============================================================
        
        if [ "${{ inputs.include_beta }}" = "true" ]; then
          echo ""
          echo "================================================================"
          echo "BETA EXPERIMENT (Historical Reference)"
          echo "================================================================"
          
          run_experiment 17 "exp_beta_initial_exploration" "EXP-BETA: Initial Exploration"
        else
          echo ""
          echo "[17/17] EXP-BETA skipped (disabled)"
        fi
        
        # ============================================================
        # Summary
        # ============================================================
        
        echo ""
        echo "================================================================"
        echo "EXECUTION SUMMARY"
        echo "================================================================"
        echo "Total experiments run: $TOTAL_COUNT"
        echo "‚úÖ Successful: $SUCCESS_COUNT"
        echo "‚ö†Ô∏è  Failed: $FAIL_COUNT"
        echo "================================================================"
        
        # Always exit 0 to allow subsequent steps
        exit 0
    
    - name: List outputs
      if: always()
      run: |
        echo "Checking outputs directory..."
        if [ -d outputs ]; then
          echo "‚úÖ outputs/ exists"
          echo ""
          echo "Directory structure:"
          ls -la outputs/
          echo ""
          echo "Summary files found:"
          find outputs -name "*summary.json" -type f
          echo ""
          echo "Total files:"
          find outputs -type f | wc -l
        else
          echo "‚ùå outputs/ not found"
        fi
    
    - name: Generate master summary
      if: always()
      run: |
        python3 << 'PYTHON_EOF'
        import json
        from pathlib import Path
        from datetime import datetime
        
        print("="*70)
        print("Generating master summary...")
        print("="*70)
        
        outputs_dir = Path("outputs")
        outputs_dir.mkdir(parents=True, exist_ok=True)
        
        # Experiment registry
        experiments = [
            ("exp_00_baseline", "exp00_baseline", "core", "O-1", "Baseline validation"),
            ("exp_01_spatial_vs_random", "exp01_spatial", "core", "O-1", "Spatial vs random"),
            ("exp_02_grid_arrangement", "exp02_grid", "core", "O-1", "Grid arrangement"),
            ("exp_03_line_arrangement", "exp03_line", "core", "O-1", "Line arrangement"),
            ("exp_04_3d_cube_arrangement", "exp04_3dcube", "core", "O-1", "3D cube"),
            ("exp_05_independence_permutation", "exp05_independence", "core", "O-1", "Independence"),
            ("exp_06_dimension_robustness", "exp06_dimension", "core", "O-1", "Dimension robustness"),
            ("exp_07_sample_size_robustness", "exp07_samplesize", "core", "O-1", "Sample size"),
            ("exp_08_metric_robustness", "exp08_metric", "core", "O-1", "Metric robustness"),
            ("exp_09_topological_disruption", "exp09_topological", "core", "O-2", "Topological disruption"),
            ("exp_10_rotation_invariance", "exp10_rotation", "core", "O-3", "Rotation invariance"),
            ("exp_11_coordinate_noise", "exp11_coordinate", "core", "O-3", "Coordinate noise"),
            ("exp_12_semantic_noise", "exp12_semantic", "core", "O-3", "Semantic noise"),
            ("exp_13_value_gate_sweep", "exp13_valuegate", "core", "O-4", "Value gate sweep"),
            ("sup_exp_14_bert", "sup14_bert", "supplementary", "O-1, O-4", "BERT validation"),
            ("sup_exp_15_multilingual", "sup15_multilingual", "supplementary", "O-1", "Multilingual"),
            ("exp_beta_initial_exploration", "exp_beta", "beta", "Reference", "Initial exploration"),
        ]
        
        master = {
            "metadata": {
                "generated_at": datetime.now().isoformat(),
                "suite_name": "Intelligence Relativity - Complete Experiment Suite",
                "repository": "intelligence-relativity",
                "total_experiments": len(experiments)
            },
            "summary": {
                "completed": 0,
                "failed": 0
            },
            "experiments": {}
        }
        
        # Collect results
        for exp_id, exp_dir, category, obs, desc in experiments:
            paths = [
                outputs_dir / exp_dir / f"{exp_dir}_summary.json",
                outputs_dir / exp_id / f"{exp_id}_summary.json",
            ]
            
            found = False
            for path in paths:
                if path.exists():
                    try:
                        with open(path) as f:
                            data = json.load(f)
                        data["metadata"] = {
                            "category": category,
                            "observation": obs,
                            "description": desc
                        }
                        master["experiments"][exp_id] = data
                        master["summary"]["completed"] += 1
                        print(f"‚úÖ {exp_id}")
                        found = True
                        break
                    except Exception as e:
                        print(f"‚ö†Ô∏è  {exp_id}: {e}")
            
            if not found:
                print(f"‚ùå {exp_id}: not found")
                master["summary"]["failed"] += 1
        
        # Save
        with open(outputs_dir / "master_summary.json", "w") as f:
            json.dump(master, f, indent=2)
        
        print(f"\n{'='*70}")
        print(f"‚úÖ Completed: {master['summary']['completed']}/{len(experiments)}")
        print(f"‚ùå Failed: {master['summary']['failed']}")
        print(f"{'='*70}")
        PYTHON_EOF
    
    - name: Create overview
      if: always()
      run: |
        python3 << 'PYTHON_EOF'
        import json
        from pathlib import Path
        
        master_file = Path("outputs/master_summary.json")
        if not master_file.exists():
            print("No master summary found")
            exit(0)
        
        with open(master_file) as f:
            master = json.load(f)
        
        lines = [
            "# Intelligence Relativity - Experiment Results\n\n",
            f"**Generated:** {master['metadata']['generated_at']}\n\n",
            f"**Completed:** {master['summary']['completed']}/{master['metadata']['total_experiments']}\n\n",
            "---\n\n",
            "## Experiments\n\n",
            "| ID | Category | Observation | Result |\n",
            "|----|----------|-------------|--------|\n"
        ]
        
        for exp_id, data in sorted(master['experiments'].items()):
            meta = data.get('metadata', {})
            cat = meta.get('category', 'N/A')
            obs = meta.get('observation', 'N/A')
            
            if 'results' in data and isinstance(data['results'], dict):
                if 'mean' in data['results']:
                    result = f"{data['results']['mean']:.4f}"
                else:
                    result = "Multiple"
            else:
                result = "See JSON"
            
            lines.append(f"| {exp_id} | {cat} | {obs} | {result} |\n")
        
        with open("outputs/EXPERIMENT_OVERVIEW.md", "w") as f:
            f.writelines(lines)
        
        print("‚úÖ Overview created")
        print("".join(lines))
        PYTHON_EOF
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: intelligence-relativity-experiments-${{ github.run_number }}
        path: outputs/
        if-no-files-found: warn
    
    - name: Summary report
      if: always()
      run: |
        COMPLETED=0
        FAILED=17
        
        if [ -f outputs/master_summary.json ]; then
          COMPLETED=$(python3 -c "import json; print(json.load(open('outputs/master_summary.json'))['summary']['completed'])" 2>/dev/null || echo "0")
          FAILED=$(python3 -c "import json; print(json.load(open('outputs/master_summary.json'))['summary']['failed'])" 2>/dev/null || echo "17")
        fi
        
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # Intelligence Relativity - Experiment Suite Results
        
        **Repository:** \`intelligence-relativity\`
        
        ## Statistics
        
        - **‚úÖ Completed:** $COMPLETED / 17
        - **‚ùå Failed:** $FAILED / 17
        
        ## Download
        
        - üì¶ **All Results:** \`intelligence-relativity-experiments-${{ github.run_number }}.zip\`
        
        ---
        
        *Empirical validation of the Relativity Theory of Intelligence*
        EOF
