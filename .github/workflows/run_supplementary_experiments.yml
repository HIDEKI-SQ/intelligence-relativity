name: Run Supplementary Experiments (SUP-14, 15, 16)

on:
  workflow_dispatch:
    inputs:
      experiments:
        description: 'Which supplementary experiments to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - sup14_bert
          - sup15_posicon
          - sup16_multilingual

jobs:
  run-supplementary:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install transformers torch
    
    - name: Run supplementary experiments
      run: |
        if [ "${{ inputs.experiments }}" = "sup14_bert" ]; then
          echo "Running SUP-14 (BERT validation)..."
          python -m src.experiments.sup_exp_14_bert
        elif [ "${{ inputs.experiments }}" = "sup15_posicon" ]; then
          echo "Running SUP-15 (Positive control)..."
          python -m src.experiments.sup_exp_15_posicon
        elif [ "${{ inputs.experiments }}" = "sup16_multilingual" ]; then
          echo "Running SUP-16 (Multilingual)..."
          python -m src.experiments.sup_exp_16_multilingual
        else
          echo "Running all supplementary experiments..."
          python -m src.experiments.sup_exp_15_posicon
          python -m src.experiments.sup_exp_14_bert
          python -m src.experiments.sup_exp_16_multilingual
        fi
    
    - name: Upload results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: supplementary-results-${{ github.run_number }}
        path: outputs/sup*/
        retention-days: 90
    
    - name: Generate summary
      if: always()
      run: |
        echo "## Supplementary Experiments Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Completed Experiments" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        for dir in outputs/sup*/; do
          if [ -d "$dir" ]; then
            exp_name=$(basename "$dir")
            echo "✅ $exp_name" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Key Findings" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- SUP-14: O-1 and O-4 validated with real BERT embeddings" >> $GITHUB_STEP_SUMMARY
        echo "- SUP-15: Measurement instrument validated (SSC ≈ 1.0)" >> $GITHUB_STEP_SUMMARY
        echo "- SUP-16: O-1 confirmed across multiple languages" >> $GITHUB_STEP_SUMMARY
